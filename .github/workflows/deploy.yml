name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar Git
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"

      - name: Clonar el C√≥digo del Helm Chart
        uses: actions/checkout@v3
        with:
          repository: Ayala217/Helm-Chart  # Asegura que clonas el repositorio correcto
          token: ${{ secrets.GH_PAT }}    # Usa el token para la autenticaci√≥n
          ref: main

      - name: Verificar archivos despu√©s del checkout
        run: ls -la  # üîç Verifica qu√© se clon√≥

      - name: Definir CHART_PATH y verificar existencia
        run: |
          echo "CHART_PATH=$(pwd)/Helm-Chart" >> $GITHUB_ENV
          echo "Directorio actual: $(pwd)"
          ls -la Helm-Chart  # üîç Verificar contenido

      - name: Instalar Helm
        run: |
          curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      - name: Inicializar el repositorio si no existe
        run: |
          cd $CHART_PATH
          if [ ! -d ".git" ]; then
            echo "‚ö†Ô∏è No es un repositorio Git. Inicializando..."
            git init
            git remote add origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/Ayala217/Helm-Chart.git
            git fetch origin main
            git checkout -b main origin/main
          fi

      - name: Crear nuevo Helm Chart Package
        run: |
          cd $CHART_PATH
          helm package . -d .  # Genera el .tgz en el mismo directorio
          ls -la

      - name: Reemplazar el archivo existente
        run: |
          cd $CHART_PATH
          rm -f microservicio-chart-0.1.0.tgz  # Borra el anterior
          mv $(ls | grep "microservicio-chart-0.1.0.tgz") microservicio-chart-0.1.0.tgz  # Renombra si es necesario
          ls -la

      - name: Actualizar Helm Repo Index
        run: |
          cd $CHART_PATH
          helm repo index . --url https://Ayala217.github.io/Helm-Chart
          ls -la

      - name: Subir cambios a GitHub
        run: |
          cd $CHART_PATH
          git add .
          git commit -m "Actualizar Helm Chart con nuevo paquete"
          git push origin main || echo "‚ö†Ô∏è No hay cambios para hacer commit."
